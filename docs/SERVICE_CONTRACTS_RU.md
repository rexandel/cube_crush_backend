# Контракты сервисов и архитектура

Этот документ описывает микросервисную архитектуру, контракты API и поток взаимодействия внутри бэкенда Cube Crush.

## Обзор архитектуры

Система построена с использованием микросервисной архитектуры и включает следующие компоненты:

1.  **API Gateway**: Точка входа для всех клиентских запросов. Отвечает за маршрутизацию, аутентификацию и балансировку нагрузки.
2.  **Auth Service**: Управляет регистрацией пользователей, аутентификацией и сессиями (JWT).
3.  **User Service**: Управляет профилями пользователей и данными учетных записей.
4.  **Game Service**: Управляет игровыми очками, таблицами лидеров и статистикой.
5.  **Eureka Server**: Реестр обнаружения сервисов (Service Discovery).

## Взаимодействие с API Gateway

API Gateway (работающий на порту `8080`) является единственной точкой входа, доступной для внешних клиентов.

### Поток аутентификации

1.  **Публичные эндпоинты**: Маршруты, такие как `/auth/login` и `/auth/register`, открыты и не требуют токена.
2.  **Защищенные эндпоинты**: Все остальные маршруты (например, `/users/me`, `/game/score`) требуют действительный JWT Access Token.
3.  **Валидация токена**:
    *   Gateway перехватывает запросы с заголовком `Authorization: Bearer <token>`.
    *   Он проверяет подпись JWT и срок его действия.
    *   Он извлекает `userId` и `nickname` (subject) из claims токена.
4.  **Проброс контекста**:
    *   Если токен валиден, Gateway добавляет внутренние заголовки к запросу перед отправкой его в целевой сервис:
        *   `X-User-Id`: ID аутентифицированного пользователя.
        *   `X-User-Email`: Никнейм аутентифицированного пользователя (сопоставленный из subject токена).

### Таблица маршрутизации

| Шаблон пути | Метод | Целевой сервис | Требуется Auth | Описание |
| :--- | :--- | :--- | :--- | :--- |
| `/api/v1/auth/register` | POST | `auth-service` | Нет | Регистрация нового пользователя |
| `/api/v1/auth/login` | POST | `auth-service` | Нет | Вход пользователя |
| `/api/v1/auth/refresh` | POST | `auth-service` | Нет | Обновление access токена |
| `/api/v1/auth/logout` | POST | `auth-service` | Да | Выход пользователя |
| `/api/v1/auth/validate` | POST | `auth-service` | Да | Валидация токена |
| `/api/v1/auth/health` | GET | `auth-service` | Нет | Проверка работоспособности |
| `/api/v1/users/**` | * | `user-service` | Да | Управление профилем пользователя |
| `/api/v1/game/**` | * | `game-service` | Смешанный* | Игровая логика (*Top/History могут быть публичными в зависимости от конфига, сейчас защищены логикой фильтра Gateway) |

---

## Контракты сервисов

### 1. Auth Service (`auth-service`)

**Ответственность**: Управление идентификацией, генерация токенов, отслеживание сессий.

**Схема базы данных**:
*   `user_sessions`: Отслеживает активные refresh токены и их валидность.
*   `revoked_tokens`: Черный список отозванных JWT (JTI).

**Публичный API**:
*   `POST /register`: Принимает `nickname`, `password`. Возвращает `AuthResponse` (токены + профиль).
*   `POST /login`: Принимает `nickname`, `password`. Возвращает `AuthResponse`.
*   `POST /refresh`: Принимает `refreshToken`. Возвращает `AuthResponse`.
*   `POST /logout`: Инвалидирует текущую сессию.

**Внутренний API** (Используется Gateway/Другими сервисами):
*   `POST /validate`: Валидирует токен и возвращает детали пользователя.

**Ключевые DTO**:
```java
// AuthResponse
{
  "accessToken": "eyJ...",
  "refreshToken": "d9b...",
  "userProfile": { "id": 1, "nickname": "Player1", "createdAt": "..." }
}
```

### 2. User Service (`user-service`)

**Ответственность**: Данные профиля пользователя, управление паролями.

**Схема базы данных**:
*   `users`: Хранит `id`, `nickname`, `password_hash`, `created_at`.

**Публичный API** (Защищен Gateway):
*   `GET /me`: Возвращает `UserProfile`. Требует заголовок `X-User-Id`.
*   `PATCH /me/nickname`: Обновляет никнейм.
*   `PATCH /me/password`: Обновляет пароль.

**Внутренний API** (Скрыт, для межсервисного взаимодействия):
*   `POST /api/v1/system/users`: Создает пользователя (вызывается Auth Service при регистрации).
*   `GET /api/v1/system/users/{id}`: Получить пользователя по ID.
*   `GET /api/v1/system/users/by-nickname/{nickname}`: Получить пользователя по никнейму.
*   `POST /api/v1/system/users/validate-credentials`: Проверка хеша пароля.

### 3. Game Service (`game-service`)

**Ответственность**: Отслеживание очков, таблицы лидеров, статистика.

**Схема базы данных**:
*   `scores`: Хранит результаты отдельных игр (`user_id`, `score`, `achieved_at`).
*   `top_players` (Materialized View): Глобальная таблица лидеров.
*   `user_stats` (Materialized View): Агрегированная статистика пользователя.

**Публичный API**:
*   `POST /score`: Отправить новый счет. Требует `X-User-Id`.
*   `GET /top`: Получить глобальную таблицу лидеров.
*   `GET /stats`: Получить статистику текущего пользователя. Требует `X-User-Id`.
*   `GET /history`: Получить историю игр текущего пользователя. Требует `X-User-Id`.

**Поток данных - Отправка счета**:
1.  Клиент отправляет `POST /api/v1/game/score` с JSON `{ "score": 100 }`.
2.  Gateway валидирует JWT, извлекает `userId=123`.
3.  Gateway пересылает запрос в Game Service с заголовком `X-User-Id: 123`.
4.  Game Service сохраняет счет в таблицу `scores`.
5.  Срабатывает триггер базы данных `refresh_views_after_score`.
6.  Обновляется представление `user_stats`.
7.  Если счет является новым рекордом, обновляется представление `top_players`.

## Согласованность базы данных

*   **User IDs**: Таблица `users` в `user-service` является источником истины для ID пользователей.
*   **Внешние ключи**: `auth-service` и `game-service` хранят `user_id`, но не обеспечивают ограничения внешних ключей на уровне базы данных между микросервисами (так как в реальном развертывании микросервисов у них разные контексты/схемы БД, хотя сейчас они используют один физический экземпляр БД).
*   **Репликация**: Данные не реплицируются; сервисы запрашивают `user-service` через REST, если им нужны детали пользователя (например, Game Service запрашивает никнейм для статистики, если он отсутствует).
